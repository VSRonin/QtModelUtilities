version: '0.0.1.{build}'

environment:
  matrix:
  - QT5: C:\Qt\5.10.1\msvc2015
    COMPILER: C:\Program Files (x86)\Microsoft Visual Studio 14.0\VC
    platform: x86
    use_cmake: "true"
    use_mingw: "false"
    use_gui: "true"
    use_widgets: "true"
    use_static: "true"
  - QT5: C:\Qt\5.10.1\msvc2015
    COMPILER: C:\Program Files (x86)\Microsoft Visual Studio 14.0\VC
    platform: x86
    use_cmake: "true"
    use_mingw: "false"
    use_gui: "true"
    use_widgets: "true"
    use_static: "false"
  - QT5: C:\Qt\5.10.1\msvc2015
    COMPILER: C:\Program Files (x86)\Microsoft Visual Studio 14.0\VC
    platform: x86
    use_cmake: "true"
    use_mingw: "false"
    use_gui: "true"
    use_widgets: "false"
    use_static: "true"
  - QT5: C:\Qt\5.10.1\msvc2015
    COMPILER: C:\Program Files (x86)\Microsoft Visual Studio 14.0\VC
    platform: x86
    use_cmake: "true"
    use_mingw: "false"
    use_gui: "true"
    use_widgets: "false"
    use_static: "false"
  - QT5: C:\Qt\5.10.1\msvc2015
    COMPILER: C:\Program Files (x86)\Microsoft Visual Studio 14.0\VC
    platform: x86
    use_cmake: "true"
    use_mingw: "false"
    use_gui: "false"
    use_widgets: "false"
    use_static: "true"
  - QT5: C:\Qt\5.10.1\msvc2015
    COMPILER: C:\Program Files (x86)\Microsoft Visual Studio 14.0\VC
    platform: x86
    use_cmake: "true"
    use_mingw: "false"
    use_gui: "false"
    use_widgets: "false"
    use_static: "false"
  - QT5: C:\Qt\5.10.1\msvc2015_64
    COMPILER: C:\Program Files (x86)\Microsoft Visual Studio 14.0\VC
    platform: amd64
    use_cmake: "true"
    use_mingw: "false"
    use_gui: "true"
    use_widgets: "true"
    use_static: "true"
  - QT5: C:\Qt\5.10.1\msvc2015_64
    COMPILER: C:\Program Files (x86)\Microsoft Visual Studio 14.0\VC
    platform: amd64
    use_cmake: "true"
    use_mingw: "false"
    use_gui: "true"
    use_widgets: "true"
    use_static: "false"
  - QT5: C:\Qt\5.10.1\msvc2015_64
    COMPILER: C:\Program Files (x86)\Microsoft Visual Studio 14.0\VC
    platform: amd64
    use_cmake: "true"
    use_mingw: "false"
    use_gui: "true"
    use_widgets: "false"
    use_static: "true"
  - QT5: C:\Qt\5.10.1\msvc2015_64
    COMPILER: C:\Program Files (x86)\Microsoft Visual Studio 14.0\VC
    platform: amd64
    use_cmake: "true"
    use_mingw: "false"
    use_gui: "true"
    use_widgets: "false"
    use_static: "false"
  - QT5: C:\Qt\5.10.1\msvc2015_64
    COMPILER: C:\Program Files (x86)\Microsoft Visual Studio 14.0\VC
    platform: amd64
    use_cmake: "true"
    use_mingw: "false"
    use_gui: "false"
    use_widgets: "false"
    use_static: "true"
  - QT5: C:\Qt\5.10.1\msvc2015_64
    COMPILER: C:\Program Files (x86)\Microsoft Visual Studio 14.0\VC
    platform: amd64
    use_cmake: "true"
    use_mingw: "false"
    use_gui: "false"
    use_widgets: "false"
    use_static: "false"
  


matrix:
  fast_finish: true

before_build:
- set PATH=%QT5%\bin;%PATH%
- if not %use_mingw%==true set PATH=%COMPILER%\bin;%QT5%\bin;%PATH%
- if not %use_mingw%==true call "%COMPILER%\vcvarsall.bat" %platform%
- if %use_static%==true (set USESTATIC=ON) else (set USESTATIC=OFF)
- if %use_gui%==true (set USEGUI=OFF) else (set USEGUI=ON)
- if %use_widgets%==true (set USEWIDGETS=OFF) else (set USEWIDGETS=ON)
- if %use_mingw%==true (set CMAKEGENERATOR="MinGW Makefiles") else (set CMAKEGENERATOR="NMake Makefiles")
- if %use_mingw%==true (set MAKEBUILDER=mingw32-make) else (set MAKEBUILDER=nmake)
- if %platform%==x86 (set TESTOUTPUTFOLDER=x86) else (set TESTOUTPUTFOLDER=x64)

build_script:
- mkdir .\build
- cd .\build
- if %use_cmake%==true (
    cmake --version &&
    cmake -G %CMAKEGENERATOR% -DCMAKE_BUILD_TYPE=RELEASE -DBUILD_TESTS=ON -DBUILD_STATIC_LIBS=%USESTATIC% -DNO_WIDGETS=%USEWIDGETS% -DNO_GUI=%USEGUI% ../ &&
    %MAKEBUILDER% &&
    cmake -G %CMAKEGENERATOR% -DCMAKE_BUILD_TYPE=DEBUG -DBUILD_TESTS=ON -DCMAKE_DEBUG_POSTFIX=d -DBUILD_STATIC_LIBS=%USESTATIC% -DNO_WIDGETS=%USEWIDGETS% -DNO_GUI=%USEGUI% ../ &&
    %MAKEBUILDER%)

test_script:
- If NOT exist "%TESTOUTPUTFOLDER%/bin" (appveyor exit)
- cd %TESTOUTPUTFOLDER%/bin
- set PATH=../lib;%PATH%
- for %%a in (*.exe) do (%%a -xml >> %%a_tstres.xml & set preventFail = 1)
- ps: $xmlOut = new-object System.Xml.XmlDocument;
    $xmlOut.AppendChild($xmlOut.CreateXmlDeclaration("1.0","UTF-8",$null));
    $rootXmlOut = $xmlOut.CreateElement("testsuites");
    $xmlOut.AppendChild($rootXmlOut);
    $totalPass = 0;
    $totalFail = 0;
    $totalError = 0;
    $totalSkip = 0;
    $totalTime = 0;
    $XmlDocument = $null;
    $crashMessage = $null;
    Get-ChildItem ".\" -Filter *_tstres.xml | Foreach-Object {
        $localPass = 0;
        $localFail = 0;
        $localError = 0;
        $localSkip = 0;
        $localTime = 0;
        if(-Not [bool]((Get-Content -Path $_.FullName) -as [xml])){
            $rawFilecontent = [IO.File]::ReadAllText($_.FullName);
            $rawFileMatch = [regex]::match($rawFilecontent,"(?s)(.+<\/TestCase>)(.*)");
            if($rawFileMatch.Success){
                if(-Not [bool](($rawFileMatch.captures.groups[1].value) -as [xml])){
                    continue;
                }
                [xml]$XmlDocument = ($rawFileMatch.captures.groups[1].value) -as [xml];
                $crashMessage = $rawFileMatch.captures.groups[2].value;
                $localError = 1;
            }
            else{
                continue;
            }
        }
        else{
            [xml]$XmlDocument = (Get-Content -Path $_.FullName) -as [xml];
        }
        $testSuiteXmlOut = $rootXmlOut.AppendChild($xmlOut.CreateElement("testsuite"));
        $testClassName = $XmlDocument.TestCase.name;
        $testSuiteXmlOut.SetAttribute("name",$testClassName);
        $testSuitePropertiesXmlOut = $testSuiteXmlOut.AppendChild($xmlOut.CreateElement("properties"));
        $testSuitePropertiesPropertyXmlOut = $testSuitePropertiesXmlOut.AppendChild($xmlOut.CreateElement("property"));
        $testSuitePropertiesPropertyXmlOut.SetAttribute("name","QtVersion");
        $testSuitePropertiesPropertyXmlOut.SetAttribute("value",[Security.SecurityElement]::Escape($XmlDocument.TestCase.Environment.QtVersion));
        $testSuitePropertiesPropertyXmlOut = $testSuitePropertiesXmlOut.AppendChild($xmlOut.CreateElement("property"));
        $testSuitePropertiesPropertyXmlOut.SetAttribute("name","QtBuild");
        $testSuitePropertiesPropertyXmlOut.SetAttribute("value",[Security.SecurityElement]::Escape($XmlDocument.TestCase.Environment.QtBuild));
        $testSuitePropertiesPropertyXmlOut = $testSuitePropertiesXmlOut.AppendChild($xmlOut.CreateElement("property"));
        $testSuitePropertiesPropertyXmlOut.SetAttribute("name","QTestVersion");
        $testSuitePropertiesPropertyXmlOut.SetAttribute("value",[Security.SecurityElement]::Escape($XmlDocument.TestCase.Environment.QTestVersion));
        foreach($testFunction in $XmlDocument.SelectNodes("//TestFunction")){
            $testFunctionName = $testFunction.name;
            $countIncidents = $testFunction.ChildNodes.Count;
            $testFunctionTime = [decimal]$testFunction.Duration.msecs;
            $localTime = $localTime +$testFunctionTime;
            foreach($incident in $testFunction.ChildNodes){
                if($incident.Name -ne "Incident" -and $incident.Name -ne "Message"){
                    continue;
                }
                $incidentName = $testFunctionName;
                if($incident.DataTag -ne $null){
                    $incidentName = $incidentName + " - " + $incident.DataTag.InnerText;
                }
                $incidentName = [Security.SecurityElement]::Escape($incidentName);
                $testSuitetestcaseXmlOut = $testSuiteXmlOut.AppendChild($xmlOut.CreateElement("testcase"));
                $testSuitetestcaseXmlOut.SetAttribute("name",$incidentName);
                $testSuitetestcaseXmlOut.SetAttribute("classname",$testClassName);
                $testSuitetestcaseXmlOut.SetAttribute("time",$testFunctionTime/(1000*$countIncidents));
                if($incident.type -eq "skip"){
                    ++$localSkip;
                    $testSuitetestcaseSkipXmlOut = $testSuitetestcaseXmlOut.AppendChild($xmlOut.CreateElement("skipped"));
                    $testSuitetestcaseSkipXmlOut.SetAttribute("message","file: " + [Security.SecurityElement]::Escape($incident.file + " line: " + $incident.line + " " + $incident.Description.InnerText));
                }
                ElseIf ($incident.type -eq "fail"){
                    ++$localFail;
                    $testSuitetestcaseSkipXmlOut = $testSuitetestcaseXmlOut.AppendChild($xmlOut.CreateElement("failure"));
                    $testSuitetestcaseSkipXmlOut.SetAttribute("message",[Security.SecurityElement]::Escape("file: " + $incident.file + " line: " + $incident.line + " " + $incident.Description.InnerText));
                }
                ElseIf ($incident.type -eq "qdebug" -or $incident.type -eq "qwarn" -or $incident.type -eq "system" -or $incident.type -eq "qfatal"){
                    $testSuitetestcaseCerrXmlOut = $testSuitetestcaseXmlOut.AppendChild($xmlOut.CreateElement("system-err"));
                    $testSuitetestcaseCerrXmlOut.AppendChild($xmlOut.CreateTextNode([Security.SecurityElement]::Escape($incident.Description.InnerText)));
                }
                else{
                    ++$localPass;
                }
            }
        }
        if($localError -eq 1){
            $testSuitetestcaseXmlOut = $testSuiteXmlOut.AppendChild($xmlOut.CreateElement("testcase"));
            $testSuitetestcaseXmlOut.SetAttribute("name","SystemError");
            $testSuitetestcaseXmlOut.SetAttribute("classname",$testClassName);
            $testSuitetestcaseErrorXmlOut = $testSuitetestcaseXmlOut.AppendChild($xmlOut.CreateElement("error"));
            $testSuitetestcaseErrorXmlOut.SetAttribute("message",[Security.SecurityElement]::Escape($crashMessage));
        }
        $testSuiteXmlOut.SetAttribute("time",$localTime/1000);
        $testSuiteXmlOut.SetAttribute("skipped",$localSkip);
        $testSuiteXmlOut.SetAttribute("tests",$localSkip+$localFail+$localError+$localPass);
        $testSuiteXmlOut.SetAttribute("failures",$localFail);
        $testSuiteXmlOut.SetAttribute("errors",$localError);
        $totalTime = $totalTime + $localTime;
        $totalSkip = $totalSkip + $localSkip;
        $totalError = $totalError + $localError;
        $totalFail = $totalFail + $localFail;
        $totalPass = $totalPass + $localPass;
    }
    $rootXmlOut.SetAttribute("time",$totalTime/1000);
    $rootXmlOut.SetAttribute("failures",$totalFail);
    $rootXmlOut.SetAttribute("errors",$totalError);
    $testSuiteXmlOut.SetAttribute("tests",$totalPass);
    $xmlOut.save($pwd.Path + "\testResults.xml");
    if($totalError+$totalFail -gt 0){
        throw
    }

on_finish:
- ps: (new-object net.webclient).UploadFile("https://ci.appveyor.com/api/testresults/junit/$($env:APPVEYOR_JOB_ID)", (Resolve-Path .\testsResults.xml))